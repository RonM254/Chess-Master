<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Master - Interactive Python Engine</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #00cec9;
            --accent-hover: #00b8b4;
            --danger: #ff7675;
            --success: #00b894;
            /* Standard Chess Colors */
            --board-light: #eeeed2;
            --board-dark: #769656;
            --highlight: rgba(255, 255, 0, 0.5);
            /* Piece Colors for contrast */
            --piece-white: #ffffff;
            --piece-black: #000000;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            font-weight: 300;
            letter-spacing: 1px;
        }

        h1 span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }

        .tab-btn:hover,
        .tab-btn.active {
            color: var(--accent);
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        /* Board Area */
        .game-area {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 40px;
            align-items: start;
        }

        .board-container {
            width: 500px;
            height: 500px;
            border: 8px solid #333;
            border-radius: 4px;
            position: relative;
            background: #333;
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            /* Ensure rows are equal height */
            width: 100%;
            height: 100%;
        }

        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            /* Larger pieces */
            cursor: pointer;
            user-select: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Proper board colors */
        .square.light {
            background-color: var(--board-light);
        }

        .square.dark {
            background-color: var(--board-dark);
        }

        /* Piece coloring logic handled in JS or specific classes */
        .square span.white-piece {
            color: var(--piece-white);
            text-shadow: 0 0 2px #000;
            /* Shadow to pop against light squares */
        }

        .square span.black-piece {
            color: var(--piece-black);
            text-shadow: 0 0 2px #fff;
            /* Shadow to pop against dark squares */
        }

        .square.selected {
            box-shadow: inset 0 0 0 4px var(--accent);
        }

        .square.last-move {
            background-color: var(--highlight) !important;
        }

        /* Panel */
        .panel {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .btn {
            background: var(--accent);
            color: #121212;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: rgba(0, 206, 201, 0.1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        textarea {
            width: 100%;
            background: #121212;
            border: 1px solid #333;
            color: var(--text-primary);
            padding: 15px;
            border-radius: 8px;
            resize: vertical;
            font-family: monospace;
            margin-bottom: 20px;
        }

        .analysis-log {
            max-height: 300px;
            overflow-y: auto;
            background: #121212;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .move-success {
            color: var(--success);
        }

        .move-error {
            color: var(--danger);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr;
            }

            .board-container {
                width: 100%;
                height: auto;
                aspect-ratio: 1/1;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>♟️ Chess <span>Master</span></h1>
            <div>
                <span style="color: var(--text-secondary);">Phase 1: Python Engine</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('play')">Play & Analyze</button>
            <button class="tab-btn" onclick="showTab('review')">Game Review</button>
            <button class="tab-btn" onclick="showTab('about')">About</button>
        </div>

        <!-- PLAY TAB -->
        <div id="play" class="tab-content active">
            <div class="game-area">
                <div class="board-container">
                    <div class="chess-board" id="board"></div>
                </div>

                <div class="panel">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Game Control</h2>
                        <span id="turn-indicator"
                            style="background: var(--accent); color: black; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">WHITE
                            TO MOVE</span>
                    </div>

                    <div class="info-grid">
                        <div class="stat-box">
                            <div class="stat-val" id="eval-score">0</div>
                            <div class="stat-label">Evaluation (cp)</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val" id="phase-label">Opening</div>
                            <div class="stat-label">Game Phase</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" onclick="resetGame()">New Game</button>
                        <button class="btn btn-outline" onclick="loadExample('italian')">Load Italian Game</button>
                        <button class="btn btn-outline" onclick="analyzePosition()">Analyze</button>
                    </div>

                    <h3>Analysis</h3>
                    <div class="analysis-log" id="play-analysis">
                        Welcome to Chess Master!
                        Click pieces to move (e.g., e2 then e4).
                        Press 'Analyze' to see engine evaluation.
                    </div>
                </div>
            </div>
        </div>

        <!-- REVIEW TAB -->
        <div id="review" class="tab-content">
            <div class="panel" style="max-width: 800px; margin: 0 auto;">
                <h2>Game Review</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Paste your game moves below to get a full move-by-move analysis report.
                    <br><em>Format: Coordinate notation preferred (e.g. "e2e4 e7e5 g1f3").</em>
                </p>

                <textarea id="review-input" rows="5" placeholder="e2e4 e7e5 g1f3 b8c6 f1c4 ..."></textarea>

                <button class="btn" onclick="reviewGame()">Generate Report</button>

                <div id="review-report" style="margin-top: 30px; display: none;">
                    <h3>Review Report</h3>
                    <div class="analysis-log" id="review-log" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- ABOUT TAB -->
        <div id="about" class="tab-content">
            <div class="panel" style="max-width: 800px; margin: 0 auto;">
                <h2>About Chess Master</h2>
                <p>This interface is powered by a <strong>Pure Python</strong> engine running locally.</p>
                <ul style="line-height: 1.8; color: var(--text-secondary);">
                    <li><strong>Zero Dependencies:</strong> No third-party libraries used in the engine.</li>
                    <li><strong>Backend:</strong> `http.server` (Standard Library)</li>
                    <li><strong>Modules:</strong> Board, Move Validator, Opening Book, Position Evaluator</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        // --- STATE ---
        let selectedSquare = null;
        let boardState = {}; // FEN, legal moves, etc.

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            resetGame();
        });

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- API CALLS ---
        async function apiCall(endpoint, data = {}) {
            try {
                const res = await fetch('/api/' + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (err) {
                console.error(err);
                return { error: "Connection error" };
            }
        }

        async function resetGame() {
            const data = await apiCall('new_game');
            updateBoard(data);
            log("Game reset.");
        }

        async function loadExample(name) {
            const data = await apiCall('example', { name });
            updateBoard(data);
            log(`Loaded ${name} opening example.`);
            analyzePosition();
        }

        async function analyzePosition() {
            const data = await apiCall('analyze');
            if (data.analysis) {
                document.getElementById('eval-score').innerText = data.analysis.total_score;
                document.getElementById('phase-label').innerText = data.analysis.phase;

                let msg = `\n--- Analysis ---\n` +
                    `Score: ${data.analysis.total_score} cp (${data.analysis.assessment})\n` +
                    `Advantage: ${data.analysis.white_advantage}\n` +
                    `Tactics: White hanging: ${data.tactics.white_hanging}, Black hanging: ${data.tactics.black_hanging}\n` +
                    `Best Moves:\n`;

                data.best_moves.forEach((m, i) => {
                    msg += `  ${i + 1}. ${m.move} (${m.score} cp)\n`;
                });
                log(msg);
            }
        }

        async function reviewGame() {
            const moves = document.getElementById('review-input').value;
            if (!moves) return;

            document.getElementById('review-report').style.display = 'block';
            const logEl = document.getElementById('review-log');
            logEl.innerHTML = "Submitting game for review...<br>";

            const data = await apiCall('review', { moves });

            if (data.report) {
                let html = "";
                let moveCount = 0;
                data.report.forEach(step => {
                    const stepClass = step.success ? "move-success" : "move-error";
                    if (step.success) {
                        moveCount++;
                        html += `<span class="${stepClass}">${moveCount}. ${step.move}</span> `;
                        html += `- Score: ${step.score} cp (${step.assessment})<br>`;
                    } else {
                        html += `<span class="${stepClass}">Error: ${step.move} - ${step.error}</span><br>`;
                    }
                });
                html += `<br><strong>Final FEN:</strong> ${data.final_fen}`;
                logEl.innerHTML = html;
            } else {
                logEl.innerHTML = "Error processing review.";
            }
        }

        // --- BOARD UI ---
        function updateBoard(state) {
            boardState = state;
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            selectedSquare = null;

            // FEN parsing (simplified)
            // rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR
            const rows = state.fen.split(' ')[0].split('/');

            for (let r = 0; r < 8; r++) {
                let colIdx = 0;
                const rowStr = rows[r];
                for (let c = 0; c < rowStr.length; c++) {
                    const char = rowStr[c];
                    if (isNaN(char)) {
                        // Piece
                        createSquare(boardEl, r, colIdx, char);
                        colIdx++;
                    } else {
                        // Empty squares
                        const count = parseInt(char);
                        for (let k = 0; k < count; k++) {
                            createSquare(boardEl, r, colIdx, null);
                            colIdx++;
                        }
                    }
                }
            }

            // Update turn indicator
            const turnEl = document.getElementById('turn-indicator');
            turnEl.innerText = state.turn.toUpperCase() + " TO MOVE";
            turnEl.style.background = state.turn === 'white' ? '#fff' : '#333';
            turnEl.style.color = state.turn === 'white' ? '#000' : '#fff';
        }

        function createSquare(parent, r, c, pieceChar) {
            const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
            const coord = files[c] + (8 - r); // e.g., "e4"

            const div = document.createElement('div');
            div.className = 'square ' + ((r + c) % 2 === 0 ? 'light' : 'dark');
            div.dataset.coord = coord;
            div.onclick = () => onSquareClick(coord);

            if (pieceChar) {
                const span = document.createElement('span');
                span.innerText = getPieceSymbol(pieceChar);
                // Uppercase = White, Lowercase = Black
                span.className = (pieceChar === pieceChar.toUpperCase()) ? 'white-piece' : 'black-piece';
                div.appendChild(span);
                div.dataset.piece = pieceChar;
            }

            parent.appendChild(div);
        }

        async function onSquareClick(coord) {
            const squares = document.querySelectorAll('.square');

            if (selectedSquare === coord) {
                // Deselect
                selectedSquare = null;
                renderHighlights();
                return;
            }

            if (selectedSquare) {
                // Attempt move
                const data = await apiCall('move', { from: selectedSquare, to: coord });
                if (data.success) {
                    updateBoard(data);
                    log(`Played ${selectedSquare}-${coord}`);
                    // Auto analyze after move
                    setTimeout(analyzePosition, 100);
                } else {
                    log(`Invalid move: ${selectedSquare}-${coord}`);
                    selectedSquare = null;
                    renderHighlights();
                }
            } else {
                // Select if there's a piece
                // Note: simple frontend check, engine validates actual turn
                const el = document.querySelector(`.square[data-coord="${coord}"]`);
                if (el && el.dataset.piece) {
                    selectedSquare = coord;
                    renderHighlights();
                    log(`Selected ${coord}`);
                }
            }
        }

        function renderHighlights() {
            document.querySelectorAll('.square').forEach(el => el.classList.remove('selected'));
            if (selectedSquare) {
                const el = document.querySelector(`.square[data-coord="${selectedSquare}"]`);
                if (el) el.classList.add('selected');
            }
        }

        function getPieceSymbol(char) {
            // Always return the "Filled" (Black) unicode set, 
            // so we can color them solid White or Black via CSS.
            // Map: P->♟, N->♞, B->♝, R->♜, Q->♛, K->♚
            const map = {
                'P': '♟', 'N': '♞', 'B': '♝', 'R': '♜', 'Q': '♛', 'K': '♚',
                'p': '♟', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♛', 'k': '♚'
            };
            return map[char] || char;
        }

        const logEl = document.getElementById('play-analysis');
        function log(msg) {
            logEl.innerText += '\n' + msg;
            logEl.scrollTop = logEl.scrollHeight;
        }

    </script>

</body>

</html>